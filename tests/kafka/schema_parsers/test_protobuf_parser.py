from metaphor.kafka.schema_parsers.protobuf_parser import ProtobufParser
from metaphor.models.metadata_change_event import SchemaField


def test_protobuf_parser(test_root_dir) -> None:
    proto_file = f"{test_root_dir}/kafka/schema_parsers/address_book.proto"
    with open(proto_file) as f:
        schema_fields = ProtobufParser.parse(f.read(), "address_book")
    assert schema_fields == [
        SchemaField(
            description=None,
            field_name="people",
            field_path="people",
            is_unique=None,
            max_length=None,
            native_type="TYPE_MESSAGE",
            nullable=None,
            precision=None,
            subfields=[
                SchemaField(
                    description=None,
                    field_name="name",
                    field_path="people.name",
                    is_unique=None,
                    max_length=None,
                    native_type="TYPE_STRING",
                    nullable=None,
                    precision=None,
                    subfields=None,
                    tags=None,
                ),
                SchemaField(
                    description=None,
                    field_name="id",
                    field_path="people.id",
                    is_unique=None,
                    max_length=None,
                    native_type="TYPE_INT32",
                    nullable=None,
                    precision=None,
                    subfields=None,
                    tags=None,
                ),
                SchemaField(
                    description=None,
                    field_name="email",
                    field_path="people.email",
                    is_unique=None,
                    max_length=None,
                    native_type="TYPE_STRING",
                    nullable=None,
                    precision=None,
                    subfields=None,
                    tags=None,
                ),
                SchemaField(
                    description=None,
                    field_name="phones",
                    field_path="people.phones",
                    is_unique=None,
                    max_length=None,
                    native_type="TYPE_MESSAGE",
                    nullable=None,
                    precision=None,
                    subfields=[
                        SchemaField(
                            description=None,
                            field_name="number",
                            field_path="people.phones.number",
                            is_unique=None,
                            max_length=None,
                            native_type="TYPE_STRING",
                            nullable=None,
                            precision=None,
                            subfields=None,
                            tags=None,
                        ),
                        SchemaField(
                            description=None,
                            field_name="type",
                            field_path="people.phones.type",
                            is_unique=None,
                            max_length=None,
                            native_type="TYPE_ENUM",
                            nullable=None,
                            precision=None,
                            subfields=None,
                            tags=None,
                        ),
                    ],
                    tags=None,
                ),
                SchemaField(
                    description=None,
                    field_name="last_updated",
                    field_path="people.last_updated",
                    is_unique=None,
                    max_length=None,
                    native_type="TYPE_MESSAGE",
                    nullable=None,
                    precision=None,
                    subfields=[
                        SchemaField(
                            description=None,
                            field_name="seconds",
                            field_path="people.last_updated.seconds",
                            is_unique=None,
                            max_length=None,
                            native_type="TYPE_INT64",
                            nullable=None,
                            precision=None,
                            subfields=None,
                            tags=None,
                        ),
                        SchemaField(
                            description=None,
                            field_name="nanos",
                            field_path="people.last_updated.nanos",
                            is_unique=None,
                            max_length=None,
                            native_type="TYPE_INT32",
                            nullable=None,
                            precision=None,
                            subfields=None,
                            tags=None,
                        ),
                    ],
                    tags=None,
                ),
            ],
            tags=None,
        )
    ]
